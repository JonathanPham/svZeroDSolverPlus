\hypertarget{integrator_8hpp_source}{}\doxysection{integrator.\+hpp}
\label{integrator_8hpp_source}\index{algebra/integrator.hpp@{algebra/integrator.hpp}}
\mbox{\hyperlink{integrator_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/**}}
\DoxyCodeLine{2 \textcolor{comment}{ * @file integrator.hpp}}
\DoxyCodeLine{3 \textcolor{comment}{ * @brief ALGEBRA::Integrator source file}}
\DoxyCodeLine{4 \textcolor{comment}{ */}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#ifndef SVZERODSOLVER\_ALGEBRA\_INTEGRATOR\_HPP\_}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#define SVZERODSOLVER\_ALGEBRA\_INTEGRATOR\_HPP\_}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <Eigen/Dense>}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include "{}../model/model.hpp"{}}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{state_8hpp}{state.hpp}}"{}}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespace_a_l_g_e_b_r_a}{ALGEBRA}}}
\DoxyCodeLine{14 \{}
\DoxyCodeLine{15 \textcolor{comment}{}}
\DoxyCodeLine{16 \textcolor{comment}{    /**}}
\DoxyCodeLine{17 \textcolor{comment}{     * @brief Generalized-\/alpha integrator}}
\DoxyCodeLine{18 \textcolor{comment}{     *}}
\DoxyCodeLine{19 \textcolor{comment}{     * This class handles the time integration scheme for solving 0D blood}}
\DoxyCodeLine{20 \textcolor{comment}{     * flow system.}}
\DoxyCodeLine{21 \textcolor{comment}{     *}}
\DoxyCodeLine{22 \textcolor{comment}{     * Flow rate, pressure, and other hemodynamic quantities in 0D models of}}
\DoxyCodeLine{23 \textcolor{comment}{     * vascular anatomies are governed by a system of nonlinear differential-\/algebraic equations (DAEs):}}
\DoxyCodeLine{24 \textcolor{comment}{     *}}
\DoxyCodeLine{25 \textcolor{comment}{     * \(\backslash\)f[}}
\DoxyCodeLine{26 \textcolor{comment}{     * \(\backslash\)mathbf\{E\}(\(\backslash\)mathbf\{y\}, t) \(\backslash\)cdot \(\backslash\)dot\{\(\backslash\)mathbf\{y\}\}+\(\backslash\)mathbf\{F\}(\(\backslash\)mathbf\{y\}, t) \(\backslash\)cdot \(\backslash\)mathbf\{y\}+\(\backslash\)mathbf\{c\}(\(\backslash\)mathbf\{y\}, t)=\(\backslash\)mathbf\{0\}}}
\DoxyCodeLine{27 \textcolor{comment}{     * \(\backslash\)f]}}
\DoxyCodeLine{28 \textcolor{comment}{     *}}
\DoxyCodeLine{29 \textcolor{comment}{     * Here, \(\backslash\)f\$y\(\backslash\)f\$ is the vector of solution quantities and \(\backslash\)f\$\(\backslash\)dot\{y\}\(\backslash\)f\$ is the time derivative of \(\backslash\)f\$y\(\backslash\)f\$.}}
\DoxyCodeLine{30 \textcolor{comment}{     * \(\backslash\)f\$N\(\backslash\)f\$ is the total number of equations and the total number of global unknowns. The DAE}}
\DoxyCodeLine{31 \textcolor{comment}{     * system is solved implicitly using the generalized-\/\(\backslash\)f\$\(\backslash\)alpha\(\backslash\)f\$ method \(\backslash\)cite JANSEN2000305.}}
\DoxyCodeLine{32 \textcolor{comment}{     *}}
\DoxyCodeLine{33 \textcolor{comment}{     * @tparam T Scalar type (e.g. `float`, `double`)}}
\DoxyCodeLine{34 \textcolor{comment}{     * @tparam S Type of System (e.g. `ALGEBRA::DenseSystem`, `ALGEBRA::SparseSystem`)}}
\DoxyCodeLine{35 \textcolor{comment}{     */}}
\DoxyCodeLine{36     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T, \textcolor{keyword}{template} <\textcolor{keyword}{class}> \textcolor{keyword}{class }\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_sparse_system}{S}}>}
\DoxyCodeLine{37     \textcolor{keyword}{class }\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_integrator}{Integrator}}}
\DoxyCodeLine{38     \{}
\DoxyCodeLine{39     \textcolor{keyword}{private}:}
\DoxyCodeLine{40         T alpha\_m;}
\DoxyCodeLine{41         T alpha\_f;}
\DoxyCodeLine{42         T alpha\_m\_inv;}
\DoxyCodeLine{43         T alpha\_f\_inv;}
\DoxyCodeLine{44         T gamma;}
\DoxyCodeLine{45         T gamma\_inv;}
\DoxyCodeLine{46         T time\_step\_size;}
\DoxyCodeLine{47         T time\_step\_size\_inv;}
\DoxyCodeLine{48         T y\_dot\_coeff;}
\DoxyCodeLine{49         T atol;}
\DoxyCodeLine{50         \textcolor{keywordtype}{int} max\_iter;}
\DoxyCodeLine{51         \textcolor{keywordtype}{int} size;}
\DoxyCodeLine{52         Eigen::Matrix<T, Eigen::Dynamic, 1> y\_af;}
\DoxyCodeLine{53         Eigen::Matrix<T, Eigen::Dynamic, 1> ydot\_am;}
\DoxyCodeLine{54         \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_sparse_system}{S<T>}} system;}
\DoxyCodeLine{55 }
\DoxyCodeLine{56     \textcolor{keyword}{public}:\textcolor{comment}{}}
\DoxyCodeLine{57 \textcolor{comment}{        /**}}
\DoxyCodeLine{58 \textcolor{comment}{         * @brief Construct a new Integrator object}}
\DoxyCodeLine{59 \textcolor{comment}{         *}}
\DoxyCodeLine{60 \textcolor{comment}{         * @param system System of equations to integrate}}
\DoxyCodeLine{61 \textcolor{comment}{         * @param time\_step\_size Time step size for generalized-\/alpha step}}
\DoxyCodeLine{62 \textcolor{comment}{         * @param rho Spectral radius for generalized-\/alpha step}}
\DoxyCodeLine{63 \textcolor{comment}{         * @param atol Absolut tolerance for non-\/linear iteration termination}}
\DoxyCodeLine{64 \textcolor{comment}{         * @param max\_iter Maximum number of non-\/linear iterations}}
\DoxyCodeLine{65 \textcolor{comment}{         */}}
\DoxyCodeLine{66         \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_integrator_ae14e4cc9d867fbd49e996aa470f1f5f6}{Integrator}}(\mbox{\hyperlink{class_m_o_d_e_l_1_1_model}{MODEL::Model<T>}} \&model, T time\_step\_size, T rho, T atol, \textcolor{keywordtype}{int} max\_iter);}
\DoxyCodeLine{67 \textcolor{comment}{}}
\DoxyCodeLine{68 \textcolor{comment}{        /**}}
\DoxyCodeLine{69 \textcolor{comment}{         * @brief Destroy the Integrator object}}
\DoxyCodeLine{70 \textcolor{comment}{         *}}
\DoxyCodeLine{71 \textcolor{comment}{         */}}
\DoxyCodeLine{72         \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_integrator_a690662bac78733a65f0a677aff476fe7}{\string~Integrator}}();}
\DoxyCodeLine{73 \textcolor{comment}{}}
\DoxyCodeLine{74 \textcolor{comment}{        /**}}
\DoxyCodeLine{75 \textcolor{comment}{         * @brief Perform a time step}}
\DoxyCodeLine{76 \textcolor{comment}{         *}}
\DoxyCodeLine{77 \textcolor{comment}{         * @param state Current state}}
\DoxyCodeLine{78 \textcolor{comment}{         * @param time Current time}}
\DoxyCodeLine{79 \textcolor{comment}{         * @param model The model}}
\DoxyCodeLine{80 \textcolor{comment}{         * @return New state}}
\DoxyCodeLine{81 \textcolor{comment}{         */}}
\DoxyCodeLine{82         \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state}{State<T>}} \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_integrator_a7ccd128be68c65beeaca85abb15e3d22}{step}}(\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state}{State<T>}} \&state, T time, \mbox{\hyperlink{class_m_o_d_e_l_1_1_model}{MODEL::Model<T>}} \&model);}
\DoxyCodeLine{83     \};}
\DoxyCodeLine{84 }
\DoxyCodeLine{85     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T, \textcolor{keyword}{template} <\textcolor{keyword}{class}> \textcolor{keyword}{class }\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_sparse_system}{S}}>}
\DoxyCodeLine{86     \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_integrator_ae14e4cc9d867fbd49e996aa470f1f5f6}{Integrator<T, S>::Integrator}}(\mbox{\hyperlink{class_m_o_d_e_l_1_1_model}{MODEL::Model<T>}} \&model, T time\_step\_size, T rho, T atol, \textcolor{keywordtype}{int} max\_iter)}
\DoxyCodeLine{87     \{}
\DoxyCodeLine{88         alpha\_m = 0.5 * (3.0 -\/ rho) / (1.0 + rho);}
\DoxyCodeLine{89         alpha\_f = 1.0 / (1.0 + rho);}
\DoxyCodeLine{90         alpha\_m\_inv = alpha\_m / 1.0;}
\DoxyCodeLine{91         alpha\_f\_inv = alpha\_f / 1.0;}
\DoxyCodeLine{92         gamma = 0.5 + alpha\_m -\/ alpha\_f;}
\DoxyCodeLine{93         gamma\_inv = 1.0 / gamma;}
\DoxyCodeLine{94 }
\DoxyCodeLine{95         system = \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_sparse_system}{S<T>}}(model.\mbox{\hyperlink{class_m_o_d_e_l_1_1_model_a43b9cc3c9874be9c2baeae576271fbad}{dofhandler}}.\mbox{\hyperlink{class_m_o_d_e_l_1_1_d_o_f_handler_acff2844be5b12678f603ca677a2c17f3}{size}}());}
\DoxyCodeLine{96         this-\/>time\_step\_size = time\_step\_size;}
\DoxyCodeLine{97         this-\/>atol = atol;}
\DoxyCodeLine{98         this-\/>max\_iter = max\_iter;}
\DoxyCodeLine{99         time\_step\_size\_inv = 1.0 / time\_step\_size;}
\DoxyCodeLine{100 }
\DoxyCodeLine{101         size = system.F.row(0).size();}
\DoxyCodeLine{102         y\_af = Eigen::Matrix<T, Eigen::Dynamic, 1>(size);}
\DoxyCodeLine{103         ydot\_am = Eigen::Matrix<T, Eigen::Dynamic, 1>(size);}
\DoxyCodeLine{104 }
\DoxyCodeLine{105         y\_dot\_coeff = alpha\_m / (alpha\_f * gamma) * time\_step\_size\_inv;}
\DoxyCodeLine{106 }
\DoxyCodeLine{107         \textcolor{comment}{// Make some memory reservations}}
\DoxyCodeLine{108         model.\mbox{\hyperlink{class_m_o_d_e_l_1_1_model_a1a0bf15374ffd41cd1fe56417375d3a2}{update\_constant}}(system);}
\DoxyCodeLine{109         model.\mbox{\hyperlink{class_m_o_d_e_l_1_1_model_a0ac10aab77f38974e91af13823d2d40a}{update\_time}}(system, 0.0);}
\DoxyCodeLine{110         Eigen::Matrix<T, Eigen::Dynamic, 1> dummy\_y = Eigen::Matrix<T, Eigen::Dynamic, 1>::Ones(size);}
\DoxyCodeLine{111         model.\mbox{\hyperlink{class_m_o_d_e_l_1_1_model_a177656d1de5a6d396e37789430fe5c77}{update\_solution}}(system, dummy\_y);}
\DoxyCodeLine{112         system.reserve(model.\mbox{\hyperlink{class_m_o_d_e_l_1_1_model_a0568bb6ffb0ee3e0ddba35ef9d1ce196}{get\_num\_triplets}}());}
\DoxyCodeLine{113     \}}
\DoxyCodeLine{114 }
\DoxyCodeLine{115     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T, \textcolor{keyword}{template} <\textcolor{keyword}{class}> \textcolor{keyword}{class }\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_sparse_system}{S}}>}
\DoxyCodeLine{116     \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_integrator_a690662bac78733a65f0a677aff476fe7}{Integrator<T, S>::\string~Integrator}}()}
\DoxyCodeLine{117     \{}
\DoxyCodeLine{118     \}}
\DoxyCodeLine{119 }
\DoxyCodeLine{120     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T, \textcolor{keyword}{template} <\textcolor{keyword}{class}> \textcolor{keyword}{class }\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_sparse_system}{S}}>}
\DoxyCodeLine{121     \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state}{State<T>}} \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_integrator_a7ccd128be68c65beeaca85abb15e3d22}{Integrator<T, S>::step}}(\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state}{State<T>}} \&old\_state, T time, \mbox{\hyperlink{class_m_o_d_e_l_1_1_model}{MODEL::Model<T>}} \&model)}
\DoxyCodeLine{122     \{}
\DoxyCodeLine{123         \textcolor{comment}{// Create new state}}
\DoxyCodeLine{124         \mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state}{State<T>}} new\_state;}
\DoxyCodeLine{125 }
\DoxyCodeLine{126         \textcolor{comment}{// Predictor step}}
\DoxyCodeLine{127         new\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_a5e310eddee49852d84d0749cbf104e57}{y}} = old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_a5e310eddee49852d84d0749cbf104e57}{y}} + 0.5 * time\_step\_size * old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}};}
\DoxyCodeLine{128         new\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}} = old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}} * (gamma -\/ 0.5) * gamma\_inv;}
\DoxyCodeLine{129 }
\DoxyCodeLine{130         \textcolor{comment}{// Initiator step}}
\DoxyCodeLine{131         y\_af = old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_a5e310eddee49852d84d0749cbf104e57}{y}} + alpha\_f * (new\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_a5e310eddee49852d84d0749cbf104e57}{y}} -\/ old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_a5e310eddee49852d84d0749cbf104e57}{y}});}
\DoxyCodeLine{132         ydot\_am = old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}} + alpha\_m * (new\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}} -\/ old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}});}
\DoxyCodeLine{133 }
\DoxyCodeLine{134         \textcolor{comment}{// Determine new time}}
\DoxyCodeLine{135         T new\_time = time + alpha\_f * time\_step\_size;}
\DoxyCodeLine{136 }
\DoxyCodeLine{137         \textcolor{comment}{// Update time-\/dependent element contributions in system}}
\DoxyCodeLine{138         model.\mbox{\hyperlink{class_m_o_d_e_l_1_1_model_a0ac10aab77f38974e91af13823d2d40a}{update\_time}}(system, new\_time);}
\DoxyCodeLine{139 }
\DoxyCodeLine{140         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < max\_iter; i++)}
\DoxyCodeLine{141         \{}
\DoxyCodeLine{142             \textcolor{comment}{// Update solution-\/dependent element contribitions}}
\DoxyCodeLine{143             model.\mbox{\hyperlink{class_m_o_d_e_l_1_1_model_a177656d1de5a6d396e37789430fe5c77}{update\_solution}}(system, y\_af);}
\DoxyCodeLine{144 }
\DoxyCodeLine{145             \textcolor{comment}{// Update residuum and check termination criteria}}
\DoxyCodeLine{146             system.update\_residual(y\_af, ydot\_am);}
\DoxyCodeLine{147             \textcolor{keywordflow}{if} (system.residual.cwiseAbs().maxCoeff() < atol)}
\DoxyCodeLine{148             \{}
\DoxyCodeLine{149                 \textcolor{keywordflow}{break};}
\DoxyCodeLine{150             \}}
\DoxyCodeLine{151 }
\DoxyCodeLine{152             \textcolor{comment}{// Abort if maximum number of non-\/linear iterations is reached}}
\DoxyCodeLine{153             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (i == max\_iter -\/ 1)}
\DoxyCodeLine{154             \{}
\DoxyCodeLine{155                 \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"{}Maxium number of non-\/linear iterations reached."{}});}
\DoxyCodeLine{156             \}}
\DoxyCodeLine{157 }
\DoxyCodeLine{158             \textcolor{comment}{// Determine jacobian}}
\DoxyCodeLine{159             system.update\_jacobian(y\_dot\_coeff);}
\DoxyCodeLine{160 }
\DoxyCodeLine{161             \textcolor{comment}{// Solve system}}
\DoxyCodeLine{162             system.solve();}
\DoxyCodeLine{163 }
\DoxyCodeLine{164             \textcolor{comment}{// Add increment to solution}}
\DoxyCodeLine{165             y\_af += system.dy;}
\DoxyCodeLine{166             ydot\_am += system.dy * y\_dot\_coeff;}
\DoxyCodeLine{167         \}}
\DoxyCodeLine{168 }
\DoxyCodeLine{169         \textcolor{comment}{// Set new state}}
\DoxyCodeLine{170         new\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_a5e310eddee49852d84d0749cbf104e57}{y}} = old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_a5e310eddee49852d84d0749cbf104e57}{y}} + (y\_af -\/ old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_a5e310eddee49852d84d0749cbf104e57}{y}}) * alpha\_f\_inv;}
\DoxyCodeLine{171         new\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}} = old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}} + (ydot\_am -\/ old\_state.\mbox{\hyperlink{class_a_l_g_e_b_r_a_1_1_state_aa1042453417a1af57edc93e3192270a9}{ydot}}) / alpha\_m\_inv;}
\DoxyCodeLine{172 }
\DoxyCodeLine{173         \textcolor{keywordflow}{return} new\_state;}
\DoxyCodeLine{174     \}}
\DoxyCodeLine{175 \} \textcolor{comment}{// namespace ALGEBRA}}
\DoxyCodeLine{176 }
\DoxyCodeLine{177 \textcolor{preprocessor}{\#endif }\textcolor{comment}{// SVZERODSOLVER\_ALGEBRA\_INTEGRATOR\_HPP\_}}

\end{DoxyCode}
